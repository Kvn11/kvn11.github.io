<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>1801811567  - Delivery</title>
  <meta name="description" content="Enumeration">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/htb/easy/writeup/delivery/2021/02/01/htb-delivery.html">
  </head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" href="/">1801811567</a>
    <br />
    
      <a href="https://github.com/kvn11" target="_blank"><span class="icon"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

    
    
      <a href="https://twitter.com/jekyllrb" target="_blank"><span class="icon"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

    
    

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Delivery</h1>
    <p class="post-meta">Last update : </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="enumeration">Enumeration</h1>

<p>The initial nmap scan reveals that there are 3 ports open:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>22/tcp   	open  ssh     		OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
80/tcp   	open  http    		nginx 1.14.2
8065/tcp	open  unknown
</code></pre></div></div>
<p>I was unsuccessful in researching what program runs on this port in my OSINT so I headed over to the box site, http://10.10.10.222. Clicking around on the site brings us to the contact us page which shows:</p>

<p><img src="/assets/images/delivery/image1.png" alt="image1.png" /></p>

<p>From this page, we can also see the domain: delivery.htb, which we should add to our /etc/hosts file. Additionally, we can now deduce that the service runing on port 8065 is a MatterMost server.</p>

<p>Heading over to helpdesk.delivery.htb shows us a system for creating support tickets. I attempt to open a new ticket to see what the process is like and if there are any potential attack vectors.</p>

<p><img src="/assets/images/delivery/image2.png" alt="image2.png" /></p>

<p>The inputs get sanitized so I wasn’t able to perform injecion of PHP code, and SQL injection didn’t work either. After filling out the form with fake/nonsense information, we are shown the following message:</p>

<p><img src="/assets/images/delivery/image3.png" alt="image3.png" /></p>

<p>This is interesting because it would seem that any message emailed to that support account will be printed in our support thread. This an important detail to note. Since I was not able to find any other attack vectors, let us see what else we can find. Checking out the sign in page leads us to an agent sign-in link, which in turn takes us to the OSTicket log in portal. I tried SQL injection again but no luck.</p>

<p><img src="/assets/images/delivery/image4.png" alt="image4.png" /></p>

<p>Now lets check out the MatterMost server. It also greets us with a log in page, but we have the ability to create a new account, or reset a password. From the homepage of delivery.htb, we know that we need an address with the domain of @delivery.htb in order to access this content.</p>

<p><img src="/assets/images/delivery/image5.png" alt="image5.png" /></p>

<h1 id="getting-user">Getting User</h1>

<p>My first thought was that since we already know of a @delivery.htb address (the one given to us after making a support ticket) then we could potentially request a password reset using that email on the MatterMost server, and then we will receive the link in the support thread, and BOOM. However, this did not work. So my next step was try to use the email account to sign up on MatterMost.</p>

<p><img src="/assets/images/delivery/image6.png" alt="image6.png" /></p>

<p>It worked! After we log into the server we find a message channel with credentials to the OSTicket server and a hint as to what the password of root might be.</p>

<p><img src="/assets/images/delivery/image7.png" alt="image7.png" /></p>

<p>Lets log into the server with the provided credentials and capture the user flag.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[kevin@ryzen ~]$ ssh maildeliverer@delivery.htb
maildeliverer@delivery.htb's password:
Linux Delivery 4.19.0-13-amd64 #1 SMP Debian 4.19.160-2 (2020-11-28) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Jan 25 07:15:19 2021 from 10.10.14.10
maildeliverer@Delivery:~$ ls
user.txt
maildeliverer@Delivery:~$ cat user.txt
c90e841382f400b84697616bb877a272
maildeliverer@Delivery:~$
</code></pre></div></div>
<h1 id="python">Python</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

</code></pre></div></div>

<h1 id="getting-root">Getting Root</h1>

<p>From the message in the MatterMost channel, we can assume that we are now looking for hashes that contain the root password. I went back to the OSTicket login portal to try and obtain to clues about where to look. Fortunately, I found a lot.</p>

<p><img src="/assets/images/delivery/image8.png" alt="image8.png" /></p>

<p>My next objective is find a MySQL database that might contain password hashes. I start by running the following command to locate where the MatterMost files are stored.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maildeliverer@Delivery:~$ find / -iname mattermost  2&gt;&amp;1 | grep -v "Permission denied"
/opt/mattermost
/opt/mattermost/bin/mattermost
/var/lib/mysql/mattermost
maildeliverer@Delivery:~$
</code></pre></div></div>
<p>I do not have sufficient permissions to access the last directory in the list. I decide to check out the first directory, /opt/mattermost. There I find a config directory with a config.json file inside. We are given a user and password to access the SQL database.</p>

<p><img src="/assets/images/delivery/image9.png" alt="image9.png" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maildeliverer@Delivery:~$ mysql -u mmuser -p
Enter password:
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 159
Server version: 10.3.27-MariaDB-0+deb10u1 Debian 10

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mattermost         |
+--------------------+
2 rows in set (0.001 sec)

MariaDB [(none)]&gt; use mattermost;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [mattermost]&gt;

</code></pre></div></div>

<p>Exploring the mattermost db reveals a Users table that contains username and password data. Most importantly, we get the root hash:</p>

<p><img src="/assets/images/delivery/image10.png" alt="image10.png" /></p>

<p>root: $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO</p>

<p>Hashid reveals this to most likely be using Blowfish encryption, mode 3200. I echo the hash into pass.txt and decide to use the best64 rule with hashcat. I also add PleaseSubscribe! to pass.txt since we know that the real password is a variation of it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[kevin@ryzen Delivery]$ hashcat -m 3200 hash.txt pass.txt -r /opt/hashcat/rules/best64.rule --show
$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO:PleaseSubscribe!21
[kevin@ryzen Delivery]$
</code></pre></div></div>

<p>Now all that remains is to su into root and obtain the root flag.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maildeliverer@Delivery:~$ su root
Password:
root@Delivery:/home/maildeliverer# cd
root@Delivery:~# cat root.txt
cd4d8dba1cea379c59a9795f553674b2
root@Delivery:~#
</code></pre></div></div>

  </div>

</article>

      </div>
    </main>

  </body>

</html>
